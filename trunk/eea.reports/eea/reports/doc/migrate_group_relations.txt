Overview
========

Migrate old reports group relations

Group relations
===============

Imports and login

    >>> from eea.reports.migration.config import REPORTS_CONTAINER, ANNOTATION_REPLACES, ANNOTATION_ISREPLACED
    >>> from eea.reports.migration.migrate_relations import MigrateRelations
    >>> from zope.app.annotation.interfaces import IAnnotations
    >>> from ZODB.PersistentList import PersistentList
    >>> self.loginAsPortalOwner()

Let's see what happends if you run this script before reports migration script

    >>> run = MigrateRelations(self.folder)
    >>> run()
    'You should run @@migrate_reports script first !!!'


Add publications container

    >>> folder_id = self.folder.invokeFactory('Folder', REPORTS_CONTAINER)
    >>> container = getattr(self.folder, folder_id)


Add some reports

    >>> _ = container.invokeFactory('Report', 'a')
    >>> _ = container.invokeFactory('Report', 'b')
    >>> _ = container.invokeFactory('Report', 'c')
    >>> _ = container.invokeFactory('Report', 'd')
    >>> _ = container.invokeFactory('Report', 'e')
    >>> _ = container.invokeFactory('Report', 'f')

    >>> a = container.a
    >>> b = container.b
    >>> c = container.c
    >>> d = container.d
    >>> e = container.e
    >>> f = container.f


Now let's make some virtual relations as migration script does
  - a => b, c
  - b => c
  - b <= a
  - c <= a, b
  - d => e
  - e <= d
  - f

    >>> rel = [b.getId(), c.getId()]
    >>> IAnnotations(a)[ANNOTATION_ISREPLACED] = PersistentList(rel)
    >>> rel = [c.getId()]
    >>> IAnnotations(b)[ANNOTATION_ISREPLACED] = PersistentList(rel)
    >>> rel = [a.getId()]
    >>> IAnnotations(b)[ANNOTATION_REPLACES] = PersistentList(rel)
    >>> rel = [a.getId(), b.getId()]
    >>> IAnnotations(c)[ANNOTATION_REPLACES] = PersistentList(rel)
    >>> rel = [e.getId()]
    >>> IAnnotations(d)[ANNOTATION_ISREPLACED] = PersistentList(rel)
    >>> rel = [d.getId()]
    >>> IAnnotations(e)[ANNOTATION_REPLACES] = PersistentList(rel)


Now let's run the migration script.

    >>> run = MigrateRelations(self.folder)
    >>> run()
    create vdex term term.a
    create vdex term term.d
    'Publications relations updated !'

First let's see if annotations were cleaned up

    >>> IAnnotations(a).get(ANNOTATION_ISREPLACED, 'Ops')
    'Ops'
    >>> IAnnotations(b).get(ANNOTATION_ISREPLACED, 'Argh')
    'Argh'
    >>> IAnnotations(b).get(ANNOTATION_REPLACES, 'Nope !')
    'Nope !'
    >>> IAnnotations(c).get(ANNOTATION_REPLACES, 'Aleeeluia !')
    'Aleeeluia !'
    >>> IAnnotations(d).get(ANNOTATION_ISREPLACED, 'Please try again later !')
    'Please try again later !'
    >>> IAnnotations(e).get(ANNOTATION_REPLACES, 'Thank you !')
    'Thank you !'


Now let's see our groups

    >>> a.getField('publication_groups').getAccessor(a)()
    ('a',)
    >>> b.getField('publication_groups').getAccessor(b)()
    ('a',)
    >>> c.getField('publication_groups').getAccessor(c)()
    ('a',)
    >>> d.getField('publication_groups').getAccessor(d)()
    ('d',)
    >>> e.getField('publication_groups').getAccessor(e)()
    ('d',)
    >>> f.getField('publication_groups').getAccessor(f)()
    ()
