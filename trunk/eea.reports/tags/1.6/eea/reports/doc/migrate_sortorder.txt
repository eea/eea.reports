Overview
========

Migrate old reports additional files sort order

Group relations
===============

Imports and login

    >>> from eea.reports.migration import config
    >>> from eea.reports.migration.zReports.parser import zreports_parser
    >>> from eea.reports.migration.migrate_sortorder import MigrateSortOrder
    >>> self.loginAsPortalOwner()

    >>> portal_languages = self.portal.portal_languages
    >>> portal_languages.addSupportedLanguage('en')
    >>> portal_languages.addSupportedLanguage('fr')
    >>> default_language = portal_languages.start_neutral and '' or portal_languages.getDefaultLanguage()

Let's see what happends if you run this script before reports migration script

    >>> run = MigrateSortOrder(self.folder)
    >>> run()
    'You should run @@migrate_reports script first !!!'


Add publications container

    >>> folder_id = self.folder.invokeFactory('Folder', config.REPORTS_CONTAINER)
    >>> container = getattr(self.folder, folder_id)
    >>> container.setLanguage(default_language)
    >>> container.addTranslation('fr')

Add some reports

    >>> _ = container.invokeFactory('Report', 'report')
    >>> en_report = container.report
    >>> en_report.setLanguage(default_language)
    >>> en_report.addTranslation('fr')
    >>> a = en_report.getTranslation('fr')

Add some additional content

    >>> files = ['add-3', 'Topic-report-16-web---part-3---', 'add-1', 'add-2', 'add-x']
    >>> for x in files:
    ...     _ = a.invokeFactory('File', x)
    >>> a.getObjectPosition('Topic-report-16-web---part-3---')
    1

Now let's parse xml

    >>> xml_file = self.loadfile('tests/data/order.xml', ctype='text/xml')
    >>> xml_text = xml_file.read()
    >>> parser = zreports_parser()
    >>> data = parser.parseHeader(xml_text)
    >>> reports = data.get_reports()
    >>> len(reports)
    1

Now that we have a list of reports, we can test our module

    >>> for datamodel in reports:
    ...     run._update_sortorder(datamodel, container)
    ...     datamodel.get('file_order')
    [u'add 1', u'add 2', u'add 3', u'Topic report 16 web - part 3 - ', u'add x']

    >>> for doc_id in a.objectIds():
    ...    a.getObjectPosition(doc_id), doc_id
    (0, 'add-1')
    (1, 'add-2')
    (2, 'add-3')
    (3, 'Topic-report-16-web---part-3---')
    (4, 'add-x')
